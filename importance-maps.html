<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <link type="text/css" rel="stylesheet" href="css/slide.css">
    <link type="text/css" rel="stylesheet" href="css/charts.css">
    <link type="text/css" rel="stylesheet" href="css/colorbrewer.css">
    <link type="text/css" rel="stylesheet" href="css/button.css">
    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <style>
#play {
    padding-left: 200px;
}
</style>
  </head>
  <body>
    <div id="body">
      <div id="header">
          Importance Maps
      </div>
      <div id="chart">
      </div>
              <div id="controls">
                  <span id="blackbox"><button class="first active">LogReg</button><button>SMLR</button><button>Ridge</button><button>Lasso</button><button class="last">Enet</button></span>
                  <span id="play"><button class="first last">Play</button></span>
              </div>
      <script type="text/javascript">

var width = 800;
    height = 600;

var margins = [10, 10, 50, 10], mb = margins[0], ml = margins[1], mt = margins[2], mr = margins[3];
var w = width - (ml + mr),
    h = height - (mb + mt);

var gridx = d3.scale.linear().range([0, 687]).domain([0,25]);
var gridy = d3.scale.linear().range([500, 0]).domain([0,20]);

var cby = d3.scale.linear().range([500, 0]).domain([0,9]);

var trx = d3.scale.linear().range([75, 612]).domain([0,16]);

var col = d3.scale.quantize().range(d3.range(9).reverse()).domain([0,9]); 
var perf_col = d3.scale.quantize().range(d3.range(9).reverse()).domain([-0.334,1]);

var svg = d3.select('#chart').append('svg:svg')
    .attr('class', 'chart')
//    .style('background','rgb(240,240,240)')
    .attr("width", width)
    .attr("height", height);

var plot = svg.append('g')
    .attr('id','plot')
    .attr('class','RdBu')
    .attr('transform','translate('+ml+','+mt+')');

var len=500;
var d = [];
for (var i=0; i < len; i++) { d.push(0) };
var curCol = [];
for (var i=0; i < len; i++) { curCol.push(0) };
var cols=['none','rgb(0,136,55)','rgb(123,50,148)'];

plot.append('g').attr('id','imp-map').selectAll('.imp1').data(d).enter().append('svg:rect')
                .attr('height',(gridy(0)-gridy(1)))
                .attr('width',(gridx(1)-gridx(0)))
                .attr('class','imp1')
                .style('stroke','none')
                .style('stroke-width','3')
                .on('click',function(d,i) { 
                    curCol[i] = (curCol[i]+1)%3; 
                    d3.selectAll('.imp1').filter(function(d,j) { return i==j; })
                        .style('stroke',cols[curCol[i]]); })
                .attr('x',function(d,i) { return ((i)%25)*(gridx(1)-gridx(0)); })
                .attr('y',function(d,i) { return Math.floor(i/25)*(gridy(0)-gridy(1));});

var rois = ['F','P','LO','MO'];

plot.append('g').attr('id','roi-lines').selectAll('.roi').data([5,10,15]).enter().append('svg:line')
    .style('stroke','black')
    .style('stroke-width','2px')
    .attr('y1',function(d) { return gridy(d);})
    .attr('y2',function(d) { return gridy(d);})
    .attr('x1',gridx(0))
    .attr('x2',gridx(25));
        
plot.select('#roi-lines').selectAll('.roi-labels').data([2.5,7.5,12.5,17.5]).enter().append('svg:text')
    .text(function(d,i) {return rois[i]; })
    .attr('y',function(d) { return gridy(d); })
    .attr('x',gridx(26));
    

plot.append('g').attr('id','colorbar').selectAll('.cb').data(d3.range(9)).enter().append('svg:rect')
                .attr('height',cby(0)-cby(1))
                .attr('width',50)
                .attr('class',function(d) { return "cb q"+col(d)+"-9"; } )
                .style('stroke','rgb(255,255,255)')
                .attr('x',750)
                .attr('y',function(d,i) { return cby(i+1); });

var trSel = plot.append('g').attr('id','tr-selector').selectAll('.cb').data(d3.range(16)).enter().append('svg:g');
    
trSel.append('svg:rect')
                .attr('height',40)
                .attr('width',trx(1)-trx(0))
                .attr('class','tr-sel q4-9')
                .on('click',function(d) { updateTR(d); })
                .style('stroke','none')
                .style('stroke-width','2')
                .attr('x',function(d,i) { return trx(i); })
                .attr('y',510);

trSel.append('svg:text')
    .text(function(d) { return d+1; })
    .attr('x',function(d,i) { return trx(i) + .5*(trx(1)-trx(0)); })
    .attr('y',535);

var myd;
var nd = [];
var curTR = 0;
var playing = false;
var t;

d3.selectAll("#play button")
    .data(['play'])
    .on("click",function(w) {
        if (playing === true)
        {
            clearTimeout(t);
            playing = false;
            d3.selectAll("#play button").text('Play').classed('active',false);
        } else {
            playing = true;
            updateTR(curTR+1);
            d3.selectAll("#play button").text('Pause').classed('active',true);
        }});

d3.selectAll("#blackbox button")
    .data(['logreg','smlr','ridge','lasso','enet'])
    .on("click",function(w) {
        d3.selectAll('#blackbox button')
            .classed('active',function(d) { return d == w; });
        loadData('data/'+w+'-weight.csv');
        loadPerf('data/'+w+'-accuracy.csv');
        });

var myperf;

var loadPerf = function(csv) {
    d3.text(csv,function(d) { 
        myperf = d3.csv.parseRows(d);

        plot.selectAll('.tr-sel')
            .attr('class',function(d,i) { return "tr-sel q"+perf_col(+myperf[i][1])+"-9"; } );
        });
};

var loadData = function(csv) {
    d3.text(csv,function(d) { 
        myd = d3.csv.parseRows(d);

        // This should probably be written more flexibly
        nd = [];
        for (var i=0; i < len; i++) { nd.push(parseFloat(myd[curTR][i+1])) };
        var mmax = d3.max([Math.abs(d3.min(nd)),d3.max(nd)])
        col.domain([-mmax,mmax]);

        plot.selectAll('.tr-sel').filter(function(d) { return d == curTR; })
            .style('stroke','black');

        plot.selectAll('.imp1').data(nd)
            .attr('class',function(d) { return "imp1 q"+col(d)+"-9"; } );
            }); 
};
         
var updateTR = function(tr) {

    plot.selectAll('.tr-sel').filter(function(d) { return d == tr; })
        .style('stroke','black');

    plot.selectAll('.tr-sel').filter(function(d) { return d == curTR; })
        .style('stroke','none');

    curTR = tr;

    nd = [];
    for (var i=0; i < len; i++) { nd.push(parseFloat(myd[tr][i+1])) };
    var mmax = d3.max([Math.abs(d3.min(nd)),d3.max(nd)])
    col.domain([-mmax,mmax]);

    plot.selectAll('.imp1').data(nd)
        .attr('class',function(d) { return "imp1 q"+col(d)+"-9"; } )

    if (playing == true) {
        t=setTimeout(function() { updateTR(tr < myd.length-1 ? tr + 1 : 0); } ,500);
    }
};

loadData('data/logreg-weight.csv');
loadPerf('data/logreg-accuracy.csv');
      </script>
    </div>
  </body>
</html>
